#!/bin/bash

# ======================================================================
getNumberOfEvents()
{
  local logfile=$1
  local ibgn iout inow
  typeset -i ibgn iout inow
  local loop=0
  ibgn=0
#  grep "Last event number" ${logfile} | sed -e "s/of this file is/:/g" | cut -d":" -f2 | \
  grep "Number of write events" ${logfile} | cut -d":" -f2 | \
  while read inow ; do
     iout=${inow}-${ibgn}
     if [ $loop -eq 0 ] ; then 
       /bin/echo -n ${iout}
     else 
       /bin/echo -n ";${iout}"
     fi
     loop=$[${loop}+1]
     ibgn=${inow}
  done
}

# =====================================================================
anallog()
{
  local rundir=$1
  local runinfo_fileurl=$2
  local runinfo_logurl=$3
  local alllog=${rundir}/all.log
  processID=`grep Stdhep ${alllog} | grep "ProcessID" | cut -d":" -f2 | sed -e "s/^ *//"`
  echo "process_id=${processID}"
  echo "`grep job_date_time ${alllog}`-GMT+0900"
  echo "process_name=`grep Stdhep ${alllog} | grep "Output File Title" | cut -d":" -f2 | sed -e "s/^ *//" `"
  echo "process_type=`grep Stdhep ${alllog} | grep "Output File Title" | cut -d":" -f2 | sed -e "s/^ *//" `"
  echo "CM_energy_in_GeV=`grep ROOTS ${alllog} | head -1 | cut -d"=" -f2 | sed -e "s/^ *//"`"
  cat runinfo_common.defs
  echo "polarization1=`grep PolElectron ${alllog} | head -1 | cut -d'=' -f 2 | sed -e 's/^ *//'` "
  echo "polarization2=`grep -e PolPositorn -e PolPositron ${alllog} | head -1 | cut -d'=' -f 2 | sed -e 's/^ *//'` "
  xsecstr=`grep "Total Cross section" ${alllog} | cut -d'=' -f 2 | sed -e 's/^ *//'` 
  xsecdat=`echo ${xsecstr} | cut -d" " -f 1`
  xsecerr=`echo ${xsecstr} | cut -d" " -f 3`
  nevtotal=`grep "Number of write events" ${alllog} | tail -1 | cut -d":" -f2 | sed -e "s/^ *//g" `
  luminosity=`perl -e "print ${nevtotal}/${xsecdat}"`
  
  echo "luminosity=${luminosity}"
  echo "cross_section_in_fb=${xsecdat}"
  echo "cross_section_error_in_fb=${xsecerr}"
  lumidir=`grep "Lumi File Directory" ${alllog} | head -1 | cut -d":" -f2 | sed -e "s/^ *//g" `
  luminum=`grep "(ISRBM)" ${alllog} | head -1 | sed -e "s/=1/=0/" | cut -d"=" -f2 `

  echo "lumi_file=${lumidir}/lumi_linker_${luminum}"
  echo "file_type=stdhep"
  echo "total_number_of_events=${nevtotal}"
  numfiles=`grep " Last file number " ${alllog} | cut -d":" -f2 | sed -e "s/^ //g" `
  echo "number_of_files=${numfiles}"
  fnames=`grep stdhep ${alllog} | grep "Output file" | cut -d" " -f8 | sed -e "s/stdhep$/stdhep;/g" | tr -d "\n" | sed -e "s/stdhep;$/stdhep/" `
  echo "file_names=${fnames}"
  echo "number_of_events_in_files=`getNumberOfEvents ${alllog}` "
  echo "fileurl=${runinfo_fileurl}"
  echo "logurl=${runinfo_logurl}/p${processID}"
}

anallog `pwd` @@RUNINFO_FILEURL@@  @@RUNINFO_LOGURL@@  > p@@ProcessID@@.txt


